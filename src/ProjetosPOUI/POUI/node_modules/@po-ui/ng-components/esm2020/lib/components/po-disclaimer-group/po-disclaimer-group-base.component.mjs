import { EventEmitter, Input, Output, Directive } from '@angular/core';
import { convertToBoolean, isKeyCodeEnter, uuid } from '../../utils/util';
import { poLocaleDefault } from '../../services/po-language/po-language.constant';
import * as i0 from "@angular/core";
import * as i1 from "../../services/po-language/po-language.service";
export const poDisclaimerGroupLiteralsDefault = {
    en: { removeAll: 'Remove all' },
    es: { removeAll: 'Eliminar todos' },
    pt: { removeAll: 'Remover todos' },
    ru: { removeAll: 'Удалить все' }
};
/**
 * @description
 *
 * O componente `po-disclaimer-group` é recomendado para manipular palavras-chave de filtros aplicados em uma pesquisa.
 *
 * À partir de dois *disclaimers* com o botão **fechar** habilitado, o componente renderiza de forma automática um novo e destacado
 * *disclaimer* que possibilita **remover todos**, mas que também pode ser desabilitado.
 *
 * Também é possível navegar entre os *disclaimers* através do teclado utilizando a tecla *tab* e, para remoção do *disclaimer* selecionado,
 * basta pressionar a tecla *enter*. Esta funcionalidade não se aplica caso a propriedade `hideClose` estiver habilitada.
 *
 * > Veja a integração destas funcionalidade no componente [po-page-list](/documentation/po-page-list).
 */
export class PoDisclaimerGroupBaseComponent {
    constructor(differs, languageService, changeDetector) {
        this.changeDetector = changeDetector;
        /**
         * @optional
         *
         * @description
         *
         * Função que será disparada quando a lista de *disclaimers* for modificada.
         */
        this.change = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Função que será disparada quando um *disclaimer* for removido da lista de *disclaimers* pelo usuário.
         *
         * Recebe como parâmetro um objeto conforme a interface `PoDisclaimerGroupRemoveAction`.
         */
        this.remove = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Função que será disparada quando todos os *disclaimers* forem removidos da lista de *disclaimers* pelo usuário,
         * utilizando o botão "remover todos".
         *
         * Recebe como parâmetro uma lista contendo todos os `disclaimers` removidos.
         */
        this.removeAll = new EventEmitter();
        this._disclaimers = [];
        this._hideRemoveAll = false;
        this.previousDisclaimers = [];
        const language = languageService.getShortLanguage();
        this.differ = differs.find([]).create(null);
        this.literals = {
            ...poDisclaimerGroupLiteralsDefault[poLocaleDefault],
            ...poDisclaimerGroupLiteralsDefault[language]
        };
    }
    /** Lista de *disclaimers*. */
    /**
     * @description
     *
     * Lista de *disclaimers*.
     *
     * Para que a lista de *disclaimers* seja atualizada dinamicamente deve-se passar uma nova referência do array de `PoDisclaimer`.
     *
     * Exemplo adicionando um *disclaimer* no array:
     *
     * ```
     * this.disclaimers = [...this.disclaimers, disclaimer];
     * ```
     *
     * ou
     *
     * ```
     * this.disclaimers = this.disclaimers.concat(disclaimer);
     * ```
     */
    set disclaimers(value) {
        this.previousDisclaimers = [...this.disclaimers];
        this._disclaimers = this.checkDisclaimers(value);
    }
    get disclaimers() {
        return this._disclaimers;
    }
    /**
     * @optional
     *
     * @description
     *
     * Oculta o botão para remover todos os *disclaimers* do grupo.
     *
     * > Por padrão, o mesmo é exibido à partir de dois ou mais *disclaimers* com a opção `hideClose` habilitada.
     *
     * @default `false`
     */
    set hideRemoveAll(value) {
        this._hideRemoveAll = value === '' ? true : convertToBoolean(value);
    }
    get hideRemoveAll() {
        return this._hideRemoveAll;
    }
    ngDoCheck() {
        this.checkChanges();
    }
    onCloseAction(disclaimer) {
        this.removeDisclaimer(disclaimer);
        this.emitChangeDisclaimers();
        this.remove.emit({
            removedDisclaimer: { ...disclaimer },
            currentDisclaimers: [...this.disclaimers]
        });
    }
    isRemoveAll() {
        return !this.hideRemoveAll && this.disclaimers.filter(c => !c.hideClose).length > 1;
    }
    onKeyPress(event) {
        if (isKeyCodeEnter(event)) {
            this.removeAllItems();
        }
    }
    removeAllItems() {
        const removeItems = [];
        this.disclaimers.forEach(disclaimer => {
            if (!disclaimer.hideClose) {
                removeItems.push(disclaimer);
            }
        });
        removeItems.forEach(disclaimer => this.removeDisclaimer(disclaimer));
        this.emitChangeDisclaimers();
        this.removeAll.emit([...removeItems]);
    }
    removeDisclaimer(disclaimer) {
        const itemIndex = this.disclaimers.findIndex(d => d['$id'] === disclaimer['$id']);
        this.disclaimers.splice(itemIndex, 1);
    }
    checkChanges() {
        if (this.differ) {
            const changes = this.differ.diff(this.disclaimers);
            if (changes && this.disclaimersAreChanged(this.disclaimers)) {
                this.emitChangeDisclaimers();
            }
        }
        else {
            this.changeDetector?.detectChanges();
        }
    }
    checkDisclaimers(disclaimers) {
        if (Array.isArray(disclaimers)) {
            for (let i = 0; i < disclaimers.length; i++) {
                const disclaimer = disclaimers[i];
                if (disclaimer.value || disclaimer.value === 0 || disclaimer.value === false) {
                    disclaimer['$id'] = uuid();
                }
                else {
                    disclaimers.splice(i, 1);
                    i--;
                }
            }
            return disclaimers;
        }
        return [];
    }
    disclaimersAreChanged(disclaimers) {
        const currentValues = disclaimers;
        if (currentValues.length !== this.previousDisclaimers.length) {
            return true;
        }
        return currentValues.some((disclaimer, index) => disclaimer.value !== this.previousDisclaimers[index].value ||
            disclaimer.property !== this.previousDisclaimers[index].property);
    }
    emitChangeDisclaimers() {
        setTimeout(() => {
            this.change.emit(this.disclaimers);
        });
        this.previousDisclaimers = [...this._disclaimers];
        this.changeDetector?.detectChanges();
    }
}
PoDisclaimerGroupBaseComponent.ɵfac = function PoDisclaimerGroupBaseComponent_Factory(t) { return new (t || PoDisclaimerGroupBaseComponent)(i0.ɵɵdirectiveInject(i0.IterableDiffers), i0.ɵɵdirectiveInject(i1.PoLanguageService), i0.ɵɵdirectiveInject(i0.ChangeDetectorRef)); };
PoDisclaimerGroupBaseComponent.ɵdir = /*@__PURE__*/ i0.ɵɵdefineDirective({ type: PoDisclaimerGroupBaseComponent, inputs: { title: ["p-title", "title"], disclaimers: ["p-disclaimers", "disclaimers"], hideRemoveAll: ["p-hide-remove-all", "hideRemoveAll"] }, outputs: { change: "p-change", remove: "p-remove", removeAll: "p-remove-all" } });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoDisclaimerGroupBaseComponent, [{
        type: Directive
    }], function () { return [{ type: i0.IterableDiffers }, { type: i1.PoLanguageService }, { type: i0.ChangeDetectorRef }]; }, { title: [{
            type: Input,
            args: ['p-title']
        }], change: [{
            type: Output,
            args: ['p-change']
        }], remove: [{
            type: Output,
            args: ['p-remove']
        }], removeAll: [{
            type: Output,
            args: ['p-remove-all']
        }], disclaimers: [{
            type: Input,
            args: ['p-disclaimers']
        }], hideRemoveAll: [{
            type: Input,
            args: ['p-hide-remove-all']
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZGlzY2xhaW1lci1ncm91cC1iYXNlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1kaXNjbGFpbWVyLWdyb3VwL3BvLWRpc2NsYWltZXItZ3JvdXAtYmFzZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFXLFlBQVksRUFBRSxLQUFLLEVBQW1CLE1BQU0sRUFBRSxTQUFTLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBRXBILE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFMUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlEQUFpRCxDQUFDOzs7QUFJbEYsTUFBTSxDQUFDLE1BQU0sZ0NBQWdDLEdBQUc7SUFDOUMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRTtJQUMvQixFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUU7SUFDbkMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRTtJQUNsQyxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFO0NBQ2pDLENBQUM7QUFFRjs7Ozs7Ozs7Ozs7O0dBWUc7QUFFSCxNQUFNLE9BQU8sOEJBQThCO0lBOEZ6QyxZQUNFLE9BQXdCLEVBQ3hCLGVBQWtDLEVBQ3hCLGNBQWlDO1FBQWpDLG1CQUFjLEdBQWQsY0FBYyxDQUFtQjtRQTdGN0M7Ozs7OztXQU1HO1FBQ2lCLFdBQU0sR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUV4RTs7Ozs7Ozs7V0FRRztRQUNpQixXQUFNLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFFeEU7Ozs7Ozs7OztXQVNHO1FBQ3FCLGNBQVMsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUl2RSxpQkFB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cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRG9DaGVjaywgRXZlbnRFbWl0dGVyLCBJbnB1dCwgSXRlcmFibGVEaWZmZXJzLCBPdXRwdXQsIERpcmVjdGl2ZSwgQ2hhbmdlRGV0ZWN0b3JSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgY29udmVydFRvQm9vbGVhbiwgaXNLZXlDb2RlRW50ZXIsIHV1aWQgfSBmcm9tICcuLi8uLi91dGlscy91dGlsJztcbmltcG9ydCB7IFBvTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tbGFuZ3VhZ2UvcG8tbGFuZ3VhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBwb0xvY2FsZURlZmF1bHQgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1sYW5ndWFnZS9wby1sYW5ndWFnZS5jb25zdGFudCc7XG5cbmltcG9ydCB7IFBvRGlzY2xhaW1lciB9IGZyb20gJy4uL3BvLWRpc2NsYWltZXIvcG8tZGlzY2xhaW1lci5pbnRlcmZhY2UnO1xuXG5leHBvcnQgY29uc3QgcG9EaXNjbGFpbWVyR3JvdXBMaXRlcmFsc0RlZmF1bHQgPSB7XG4gIGVuOiB7IHJlbW92ZUFsbDogJ1JlbW92ZSBhbGwnIH0sXG4gIGVzOiB7IHJlbW92ZUFsbDogJ0VsaW1pbmFyIHRvZG9zJyB9LFxuICBwdDogeyByZW1vdmVBbGw6ICdSZW1vdmVyIHRvZG9zJyB9LFxuICBydTogeyByZW1vdmVBbGw6ICfQo9C00LDQu9C40YLRjCDQstGB0LUnIH1cbn07XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogTyBjb21wb25lbnRlIGBwby1kaXNjbGFpbWVyLWdyb3VwYCDDqSByZWNvbWVuZGFkbyBwYXJhIG1hbmlwdWxhciBwYWxhdnJhcy1jaGF2ZSBkZSBmaWx0cm9zIGFwbGljYWRvcyBlbSB1bWEgcGVzcXVpc2EuXG4gKlxuICogw4AgcGFydGlyIGRlIGRvaXMgKmRpc2NsYWltZXJzKiBjb20gbyBib3TDo28gKipmZWNoYXIqKiBoYWJpbGl0YWRvLCBvIGNvbXBvbmVudGUgcmVuZGVyaXphIGRlIGZvcm1hIGF1dG9tw6F0aWNhIHVtIG5vdm8gZSBkZXN0YWNhZG9cbiAqICpkaXNjbGFpbWVyKiBxdWUgcG9zc2liaWxpdGEgKipyZW1vdmVyIHRvZG9zKiosIG1hcyBxdWUgdGFtYsOpbSBwb2RlIHNlciBkZXNhYmlsaXRhZG8uXG4gKlxuICogVGFtYsOpbSDDqSBwb3Nzw612ZWwgbmF2ZWdhciBlbnRyZSBvcyAqZGlzY2xhaW1lcnMqIGF0cmF2w6lzIGRvIHRlY2xhZG8gdXRpbGl6YW5kbyBhIHRlY2xhICp0YWIqIGUsIHBhcmEgcmVtb8Onw6NvIGRvICpkaXNjbGFpbWVyKiBzZWxlY2lvbmFkbyxcbiAqIGJhc3RhIHByZXNzaW9uYXIgYSB0ZWNsYSAqZW50ZXIqLiBFc3RhIGZ1bmNpb25hbGlkYWRlIG7Do28gc2UgYXBsaWNhIGNhc28gYSBwcm9wcmllZGFkZSBgaGlkZUNsb3NlYCBlc3RpdmVyIGhhYmlsaXRhZGEuXG4gKlxuICogPiBWZWphIGEgaW50ZWdyYcOnw6NvIGRlc3RhcyBmdW5jaW9uYWxpZGFkZSBubyBjb21wb25lbnRlIFtwby1wYWdlLWxpc3RdKC9kb2N1bWVudGF0aW9uL3BvLXBhZ2UtbGlzdCkuXG4gKi9cbkBEaXJlY3RpdmUoKVxuZXhwb3J0IGNsYXNzIFBvRGlzY2xhaW1lckdyb3VwQmFzZUNvbXBvbmVudCBpbXBsZW1lbnRzIERvQ2hlY2sge1xuICAvKiogVMOtdHVsbyBkbyBncnVwbyBkZSAqZGlzY2xhaW1lcnMqLiAqL1xuICBASW5wdXQoJ3AtdGl0bGUnKSB0aXRsZT86IHN0cmluZztcblxuICAvKipcbiAgICogQG9wdGlvbmFsXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBGdW7Dp8OjbyBxdWUgc2Vyw6EgZGlzcGFyYWRhIHF1YW5kbyBhIGxpc3RhIGRlICpkaXNjbGFpbWVycyogZm9yIG1vZGlmaWNhZGEuXG4gICAqL1xuICBAT3V0cHV0KCdwLWNoYW5nZScpIGNoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAvKipcbiAgICogQG9wdGlvbmFsXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBGdW7Dp8OjbyBxdWUgc2Vyw6EgZGlzcGFyYWRhIHF1YW5kbyB1bSAqZGlzY2xhaW1lciogZm9yIHJlbW92aWRvIGRhIGxpc3RhIGRlICpkaXNjbGFpbWVycyogcGVsbyB1c3XDoXJpby5cbiAgICpcbiAgICogUmVjZWJlIGNvbW8gcGFyw6JtZXRybyB1bSBvYmpldG8gY29uZm9ybWUgYSBpbnRlcmZhY2UgYFBvRGlzY2xhaW1lckdyb3VwUmVtb3ZlQWN0aW9uYC5cbiAgICovXG4gIEBPdXRwdXQoJ3AtcmVtb3ZlJykgcmVtb3ZlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIC8qKlxuICAgKiBAb3B0aW9uYWxcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEZ1bsOnw6NvIHF1ZSBzZXLDoSBkaXNwYXJhZGEgcXVhbmRvIHRvZG9zIG9zICpkaXNjbGFpbWVycyogZm9yZW0gcmVtb3ZpZG9zIGRhIGxpc3RhIGRlICpkaXNjbGFpbWVycyogcGVsbyB1c3XDoXJpbyxcbiAgICogdXRpbGl6YW5kbyBvIGJvdMOjbyBcInJlbW92ZXIgdG9kb3NcIi5cbiAgICpcbiAgICogUmVjZWJlIGNvbW8gcGFyw6JtZXRybyB1bWEgbGlzdGEgY29udGVuZG8gdG9kb3Mgb3MgYGRpc2NsYWltZXJzYCByZW1vdmlkb3MuXG4gICAqL1xuICBAT3V0cHV0KCdwLXJlbW92ZS1hbGwnKSByZW1vdmVBbGw6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgbGl0ZXJhbHM7XG5cbiAgcHJpdmF0ZSBfZGlzY2xhaW1lcnM6IEFycmF5PFBvRGlzY2xhaW1lcj4gPSBbXTtcbiAgcHJpdmF0ZSBfaGlkZVJlbW92ZUFsbDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHByaXZhdGUgZGlmZmVyO1xuICBwcml2YXRlIHByZXZpb3VzRGlzY2xhaW1lcnM6IEFycmF5PFBvRGlzY2xhaW1lcj4gPSBbXTtcblxuICAvKiogTGlzdGEgZGUgKmRpc2NsYWltZXJzKi4gKi9cblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIExpc3RhIGRlICpkaXNjbGFpbWVycyouXG4gICAqXG4gICAqIFBhcmEgcXVlIGEgbGlzdGEgZGUgKmRpc2NsYWltZXJzKiBzZWphIGF0dWFsaXphZGEgZGluYW1pY2FtZW50ZSBkZXZlLXNlIHBhc3NhciB1bWEgbm92YSByZWZlcsOqbmNpYSBkbyBhcnJheSBkZSBgUG9EaXNjbGFpbWVyYC5cbiAgICpcbiAgICogRXhlbXBsbyBhZGljaW9uYW5kbyB1bSAqZGlzY2xhaW1lciogbm8gYXJyYXk6XG4gICAqXG4gICAqIGBgYFxuICAgKiB0aGlzLmRpc2NsYWltZXJzID0gWy4uLnRoaXMuZGlzY2xhaW1lcnMsIGRpc2NsYWltZXJdO1xuICAgKiBgYGBcbiAgICpcbiAgICogb3VcbiAgICpcbiAgICogYGBgXG4gICAqIHRoaXMuZGlzY2xhaW1lcnMgPSB0aGlzLmRpc2NsYWltZXJzLmNvbmNhdChkaXNjbGFpbWVyKTtcbiAgICogYGBgXG4gICAqL1xuICBASW5wdXQoJ3AtZGlzY2xhaW1lcnMnKSBzZXQgZGlzY2xhaW1lcnModmFsdWU6IEFycmF5PFBvRGlzY2xhaW1lcj4pIHtcbiAgICB0aGlzLnByZXZpb3VzRGlzY2xhaW1lcnMgPSBbLi4udGhpcy5kaXNjbGFpbWVyc107XG4gICAgdGhpcy5fZGlzY2xhaW1lcnMgPSB0aGlzLmNoZWNrRGlzY2xhaW1lcnModmFsdWUpO1xuICB9XG5cbiAgZ2V0IGRpc2NsYWltZXJzKCkge1xuICAgIHJldHVybiB0aGlzLl9kaXNjbGFpbWVycztcbiAgfVxuXG4gIC8qKlxuICAgKiBAb3B0aW9uYWxcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIE9jdWx0YSBvIGJvdMOjbyBwYXJhIHJlbW92ZXIgdG9kb3Mgb3MgKmRpc2NsYWltZXJzKiBkbyBncnVwby5cbiAgICpcbiAgICogPiBQb3IgcGFkcsOjbywgbyBtZXNtbyDDqSBleGliaWRvIMOgIHBhcnRpciBkZSBkb2lzIG91IG1haXMgKmRpc2NsYWltZXJzKiBjb20gYSBvcMOnw6NvIGBoaWRlQ2xvc2VgIGhhYmlsaXRhZGEuXG4gICAqXG4gICAqIEBkZWZhdWx0IGBmYWxzZWBcbiAgICovXG4gIEBJbnB1dCgncC1oaWRlLXJlbW92ZS1hbGwnKVxuICBzZXQgaGlkZVJlbW92ZUFsbCh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuX2hpZGVSZW1vdmVBbGwgPSA8YW55PnZhbHVlID09PSAnJyA/IHRydWUgOiBjb252ZXJ0VG9Cb29sZWFuKHZhbHVlKTtcbiAgfVxuXG4gIGdldCBoaWRlUmVtb3ZlQWxsKCkge1xuICAgIHJldHVybiB0aGlzLl9oaWRlUmVtb3ZlQWxsO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgZGlmZmVyczogSXRlcmFibGVEaWZmZXJzLFxuICAgIGxhbmd1YWdlU2VydmljZTogUG9MYW5ndWFnZVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZlxuICApIHtcbiAgICBjb25zdCBsYW5ndWFnZSA9IGxhbmd1YWdlU2VydmljZS5nZXRTaG9ydExhbmd1YWdlKCk7XG5cbiAgICB0aGlzLmRpZmZlciA9IGRpZmZlcnMuZmluZChbXSkuY3JlYXRlKG51bGwpO1xuXG4gICAgdGhpcy5saXRlcmFscyA9IHtcbiAgICAgIC4uLnBvRGlzY2xhaW1lckdyb3VwTGl0ZXJhbHNEZWZhdWx0W3BvTG9jYWxlRGVmYXVsdF0sXG4gICAgICAuLi5wb0Rpc2NsYWltZXJHcm91cExpdGVyYWxzRGVmYXVsdFtsYW5ndWFnZV1cbiAgICB9O1xuICB9XG5cbiAgbmdEb0NoZWNrKCkge1xuICAgIHRoaXMuY2hlY2tDaGFuZ2VzKCk7XG4gIH1cblxuICBvbkNsb3NlQWN0aW9uKGRpc2NsYWltZXIpIHtcbiAgICB0aGlzLnJlbW92ZURpc2NsYWltZXIoZGlzY2xhaW1lcik7XG5cbiAgICB0aGlzLmVtaXRDaGFuZ2VEaXNjbGFpbWVycygpO1xuICAgIHRoaXMucmVtb3ZlLmVtaXQoe1xuICAgICAgcmVtb3ZlZERpc2NsYWltZXI6IHsgLi4uZGlzY2xhaW1lciB9LFxuICAgICAgY3VycmVudERpc2NsYWltZXJzOiBbLi4udGhpcy5kaXNjbGFpbWVyc11cbiAgICB9KTtcbiAgfVxuXG4gIGlzUmVtb3ZlQWxsKCkge1xuICAgIHJldHVybiAhdGhpcy5oaWRlUmVtb3ZlQWxsICYmIHRoaXMuZGlzY2xhaW1lcnMuZmlsdGVyKGMgPT4gIWMuaGlkZUNsb3NlKS5sZW5ndGggPiAxO1xuICB9XG5cbiAgb25LZXlQcmVzcyhldmVudDogYW55KSB7XG4gICAgaWYgKGlzS2V5Q29kZUVudGVyKGV2ZW50KSkge1xuICAgICAgdGhpcy5yZW1vdmVBbGxJdGVtcygpO1xuICAgIH1cbiAgfVxuXG4gIHJlbW92ZUFsbEl0ZW1zKCkge1xuICAgIGNvbnN0IHJlbW92ZUl0ZW1zID0gW107XG5cbiAgICB0aGlzLmRpc2NsYWltZXJzLmZvckVhY2goZGlzY2xhaW1lciA9PiB7XG4gICAgICBpZiAoIWRpc2NsYWltZXIuaGlkZUNsb3NlKSB7XG4gICAgICAgIHJlbW92ZUl0ZW1zLnB1c2goZGlzY2xhaW1lcik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZW1vdmVJdGVtcy5mb3JFYWNoKGRpc2NsYWltZXIgPT4gdGhpcy5yZW1vdmVEaXNjbGFpbWVyKGRpc2NsYWltZXIpKTtcblxuICAgIHRoaXMuZW1pdENoYW5nZURpc2NsYWltZXJzKCk7XG4gICAgdGhpcy5yZW1vdmVBbGwuZW1pdChbLi4ucmVtb3ZlSXRlbXNdKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRGlzY2xhaW1lcihkaXNjbGFpbWVyOiBhbnkpIHtcbiAgICBjb25zdCBpdGVtSW5kZXggPSB0aGlzLmRpc2NsYWltZXJzLmZpbmRJbmRleChkID0+IGRbJyRpZCddID09PSBkaXNjbGFpbWVyWyckaWQnXSk7XG4gICAgdGhpcy5kaXNjbGFpbWVycy5zcGxpY2UoaXRlbUluZGV4LCAxKTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tDaGFuZ2VzKCkge1xuICAgIGlmICh0aGlzLmRpZmZlcikge1xuICAgICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuZGlmZmVyLmRpZmYodGhpcy5kaXNjbGFpbWVycyk7XG5cbiAgICAgIGlmIChjaGFuZ2VzICYmIHRoaXMuZGlzY2xhaW1lcnNBcmVDaGFuZ2VkKHRoaXMuZGlzY2xhaW1lcnMpKSB7XG4gICAgICAgIHRoaXMuZW1pdENoYW5nZURpc2NsYWltZXJzKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3I/LmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNoZWNrRGlzY2xhaW1lcnMoZGlzY2xhaW1lcnM6IEFycmF5PFBvRGlzY2xhaW1lcj4pIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShkaXNjbGFpbWVycykpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGlzY2xhaW1lcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgZGlzY2xhaW1lciA9IGRpc2NsYWltZXJzW2ldO1xuXG4gICAgICAgIGlmIChkaXNjbGFpbWVyLnZhbHVlIHx8IGRpc2NsYWltZXIudmFsdWUgPT09IDAgfHwgZGlzY2xhaW1lci52YWx1ZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICBkaXNjbGFpbWVyWyckaWQnXSA9IHV1aWQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkaXNjbGFpbWVycy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgaS0tO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBkaXNjbGFpbWVycztcbiAgICB9XG5cbiAgICByZXR1cm4gW107XG4gIH1cblxuICBwcml2YXRlIGRpc2NsYWltZXJzQXJlQ2hhbmdlZChkaXNjbGFpbWVyczogQXJyYXk8UG9EaXNjbGFpbWVyPik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGN1cnJlbnRWYWx1ZXM6IEFycmF5PFBvRGlzY2xhaW1lcj4gPSBkaXNjbGFpbWVycztcblxuICAgIGlmIChjdXJyZW50VmFsdWVzLmxlbmd0aCAhPT0gdGhpcy5wcmV2aW91c0Rpc2NsYWltZXJzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGN1cnJlbnRWYWx1ZXMuc29tZShcbiAgICAgIChkaXNjbGFpbWVyLCBpbmRleCkgPT5cbiAgICAgICAgZGlzY2xhaW1lci52YWx1ZSAhPT0gdGhpcy5wcmV2aW91c0Rpc2NsYWltZXJzW2luZGV4XS52YWx1ZSB8fFxuICAgICAgICBkaXNjbGFpbWVyLnByb3BlcnR5ICE9PSB0aGlzLnByZXZpb3VzRGlzY2xhaW1lcnNbaW5kZXhdLnByb3BlcnR5XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZW1pdENoYW5nZURpc2NsYWltZXJzKCkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5jaGFuZ2UuZW1pdCh0aGlzLmRpc2NsYWltZXJzKTtcbiAgICB9KTtcbiAgICB0aGlzLnByZXZpb3VzRGlzY2xhaW1lcnMgPSBbLi4udGhpcy5fZGlzY2xhaW1lcnNdO1xuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3I/LmRldGVjdENoYW5nZXMoKTtcbiAgfVxufVxuIl19