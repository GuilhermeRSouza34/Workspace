import { Injectable } from '@angular/core';
import { finalize } from 'rxjs/operators';
import { PoLoadingOverlayComponent } from '../../components/po-loading/po-loading-overlay/po-loading-overlay.component';
import * as i0 from "@angular/core";
import * as i1 from "./po-http-request-control-service";
import * as i2 from "../../services/po-component-injector/po-component-injector.service";
const noCountPendingRequests = 'X-PO-No-Count-Pending-Requests';
const screenLock = 'X-PO-Screen-Lock';
/**
 * @description
 *
 * O serviço PO Http Request Interceptor realiza a contabilização de requisições pendentes na aplicação.
 *
 * Existe a possibilidade de não efetuar a contabilização das requisições pendentes, utilizando o parâmetro
 * `X-PO-No-Count-Pending-Requests`. Para isso deve ser informado no cabeçalho da requisição com o valor `'true'`,
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-PO-No-Count-Pending-Requests': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * Para obter a quantidade de requisições pendentes, deve inscrever-se no método `getCountPendingRequests` do
 * serviço `PoHttpRequestInterceptorService`, com isso, ao realizar requisições utilizando `HttpClient`,
 * será retornado a quantidade de requisições pendentes.
 *
 * Também existe a possibildade de travar a tela e mostrar uma imagem de _loading_ durante o processamento de uma requisição
 * deve-se passar o parâmetro `X-PO-Screen-Lock` no cabeçalho da requisição com valor `'true'`.
 *
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-PO-Screen-Lock': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * > Após a validação no interceptor, o parâmetro será removido do cabeçalho da requisição.
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-request-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 *
 * Segue abaixo um exemplo de uso:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class CustomersService {
 *
 *  headers = { 'X-PO-No-Count-Pending-Requests': true, 'X-PO-Screen-Lock': 'true' }
 *  pendingRequests: number = 0;
 *  subscription: Subscription;
 *
 *  constructor(
 *    private http: HttpClient,
 *    private httpRequestInterceptor: PoHttpRequestInterceptorService) { }
 *
 *  ngOnDestroy(): void {
 *    this.subscription.unsubscribe();
 *  }
 *
 *  ngOnInit(): void {
 *    this.subscription = this.httpRequestInterceptor.getCountPendingRequests().subscribe(data => {
 *      this.pendingRequests = data;
 *    });
 *  }
 *
 *  getCustomers() {
 *    return this.http.get(`/customers/1`, { headers: headers });
 *  }
 *
 *  ...
 *
 * }
 * ```
 *
 * @example
 * <example name='po-http-request-interceptor-labs' title='PO Http Request Interceptor Labs'>
 *  <file name='sample-po-http-request-interceptor-labs.component.ts'> </file>
 *  <file name='sample-po-http-request-interceptor-labs.component.html'> </file>
 * </example>
 */
export class PoHttpRequestInterceptorService {
    constructor(controlHttpRequest, poComponentInjector) {
        this.controlHttpRequest = controlHttpRequest;
        this.poComponentInjector = poComponentInjector;
        this.loadingOverlayComponent = undefined;
        this.pendingRequests = 0;
        this.overlayRequests = 0;
    }
    intercept(request, next) {
        const requestClone = request.clone();
        request = this.requestCloneWithoutHeaderParam([noCountPendingRequests, screenLock], request);
        this.setCountPendingRequests(true, requestClone);
        this.setCountOverlayRequests(true, requestClone);
        return next.handle(request).pipe(finalize(() => {
            this.setCountPendingRequests(false, requestClone);
            this.setCountOverlayRequests(false, requestClone);
        }));
    }
    getCountPendingRequests() {
        return this.controlHttpRequest.getControlHttpRequest();
    }
    buildLoading() {
        if (!this.loadingOverlayComponent) {
            this.loadingOverlayComponent = this.poComponentInjector.createComponentInApplication(PoLoadingOverlayComponent);
            this.loadingOverlayComponent.instance.screenLock = true;
            this.loadingOverlayComponent.instance.changeDetector.detectChanges();
        }
    }
    destroyLoading() {
        if (this.loadingOverlayComponent) {
            this.poComponentInjector.destroyComponentInApplication(this.loadingOverlayComponent);
            this.loadingOverlayComponent = undefined;
        }
    }
    requestCloneWithoutHeaderParam(headersParams, request) {
        let isRequestClone = false;
        headersParams.forEach(headerParam => {
            if (request.headers.has(headerParam)) {
                request = request.clone({ headers: request.headers.delete(headerParam) });
                isRequestClone = true;
            }
        });
        return isRequestClone ? request.clone({ headers: request.headers }) : request;
    }
    setCountPendingRequests(isIncrement, request) {
        const hasCountPendingRequestHeaderParam = request.headers.has(noCountPendingRequests);
        const headerParam = request.headers.get(noCountPendingRequests);
        if (hasCountPendingRequestHeaderParam && headerParam.toString().toLowerCase() === 'true') {
            return;
        }
        this.pendingRequests += isIncrement ? 1 : -1;
        this.controlHttpRequest.send(this.pendingRequests);
    }
    setCountOverlayRequests(isIncrement, request) {
        const hasOverlayRequestHeaderParam = request.headers.has(screenLock);
        if (hasOverlayRequestHeaderParam) {
            const headerParam = request.headers.get(screenLock);
            if (headerParam.toString().toLowerCase() === 'false') {
                return;
            }
            this.overlayRequests += isIncrement ? 1 : -1;
            this.overlayRequests > 0 ? this.buildLoading() : this.destroyLoading();
        }
    }
}
PoHttpRequestInterceptorService.ɵfac = function PoHttpRequestInterceptorService_Factory(t) { return new (t || PoHttpRequestInterceptorService)(i0.ɵɵinject(i1.PoHttpRequesControltService), i0.ɵɵinject(i2.PoComponentInjectorService)); };
PoHttpRequestInterceptorService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: PoHttpRequestInterceptorService, factory: PoHttpRequestInterceptorService.ɵfac, providedIn: 'root' });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoHttpRequestInterceptorService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: i1.PoHttpRequesControltService }, { type: i2.PoComponentInjectorService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2ludGVyY2VwdG9ycy9wby1odHRwLXJlcXVlc3QvcG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFnQixVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHekQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzFDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDZFQUE2RSxDQUFDOzs7O0FBR3hILE1BQU0sc0JBQXNCLEdBQUcsZ0NBQWdDLENBQUM7QUFDaEUsTUFBTSxVQUFVLEdBQUcsa0JBQWtCLENBQUM7QUFFdEM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FrRkc7QUFJSCxNQUFNLE9BQU8sK0JBQStCO0lBTTFDLFlBQ1Usa0JBQStDLEVBQy9DLG1CQUErQztRQUQvQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQTZCO1FBQy9DLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBNEI7UUFQakQsNEJBQXVCLEdBQTRDLFNBQVMsQ0FBQztRQUU3RSxvQkFBZSxHQUFXLENBQUMsQ0FBQztRQUM1QixvQkFBZSxHQUFXLENBQUMsQ0FBQztJQUtqQyxDQUFDO0lBRUosU0FBUyxDQUFDLE9BQXlCLEVBQUUsSUFBaUI7UUFDcEQsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXJDLE9BQU8sR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsQ0FBQyxzQkFBc0IsRUFBRSxVQUFVLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUU3RixJQUFJLENB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WUFDaEMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7WUFFcEQsSUFBSSxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxFQUFFLEtBQUssT0FBTyxFQUFFO2dCQUNwRCxPQUFPO2FBQ1I7WUFFRCxJQUFJLENBQUMsZUFBZSxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QyxJQUFJLENBQUMsZUFBZSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDeEU7SUFDSCxDQUFDOzs4R0FwRlUsK0JBQStCO3FGQUEvQiwrQkFBK0IsV0FBL0IsK0JBQStCLG1CQUY5QixNQUFNO3VGQUVQLCtCQUErQjtjQUgzQyxVQUFVO2VBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwSGFuZGxlciwgSHR0cEludGVyY2VwdG9yLCBIdHRwUmVxdWVzdCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IENvbXBvbmVudFJlZiwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaW5hbGl6ZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgUG9Db21wb25lbnRJbmplY3RvclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1jb21wb25lbnQtaW5qZWN0b3IvcG8tY29tcG9uZW50LWluamVjdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9Mb2FkaW5nT3ZlcmxheUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvcG8tbG9hZGluZy9wby1sb2FkaW5nLW92ZXJsYXkvcG8tbG9hZGluZy1vdmVybGF5LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb0h0dHBSZXF1ZXNDb250cm9sdFNlcnZpY2UgfSBmcm9tICcuL3BvLWh0dHAtcmVxdWVzdC1jb250cm9sLXNlcnZpY2UnO1xuXG5jb25zdCBub0NvdW50UGVuZGluZ1JlcXVlc3RzID0gJ1gtUE8tTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc7XG5jb25zdCBzY3JlZW5Mb2NrID0gJ1gtUE8tU2NyZWVuLUxvY2snO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIE8gc2VydmnDp28gUE8gSHR0cCBSZXF1ZXN0IEludGVyY2VwdG9yIHJlYWxpemEgYSBjb250YWJpbGl6YcOnw6NvIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzIG5hIGFwbGljYcOnw6NvLlxuICpcbiAqIEV4aXN0ZSBhIHBvc3NpYmlsaWRhZGUgZGUgbsOjbyBlZmV0dWFyIGEgY29udGFiaWxpemHDp8OjbyBkYXMgcmVxdWlzacOnw7VlcyBwZW5kZW50ZXMsIHV0aWxpemFuZG8gbyBwYXLDom1ldHJvXG4gKiBgWC1QTy1Oby1Db3VudC1QZW5kaW5nLVJlcXVlc3RzYC4gUGFyYSBpc3NvIGRldmUgc2VyIGluZm9ybWFkbyBubyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8OjbyBjb20gbyB2YWxvciBgJ3RydWUnYCxcbiAqIHBvciBleGVtcGxvOlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUE8tTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc6ICd0cnVlJyB9O1xuICpcbiAqICB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAuLi5cbiAqXG4gKiBgYGBcbiAqIFBhcmEgb2J0ZXIgYSBxdWFudGlkYWRlIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLCBkZXZlIGluc2NyZXZlci1zZSBubyBtw6l0b2RvIGBnZXRDb3VudFBlbmRpbmdSZXF1ZXN0c2AgZG9cbiAqIHNlcnZpw6dvIGBQb0h0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlYCwgY29tIGlzc28sIGFvIHJlYWxpemFyIHJlcXVpc2nDp8O1ZXMgdXRpbGl6YW5kbyBgSHR0cENsaWVudGAsXG4gKiBzZXLDoSByZXRvcm5hZG8gYSBxdWFudGlkYWRlIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLlxuICpcbiAqIFRhbWLDqW0gZXhpc3RlIGEgcG9zc2liaWxkYWRlIGRlIHRyYXZhciBhIHRlbGEgZSBtb3N0cmFyIHVtYSBpbWFnZW0gZGUgX2xvYWRpbmdfIGR1cmFudGUgbyBwcm9jZXNzYW1lbnRvIGRlIHVtYSByZXF1aXNpw6fDo29cbiAqIGRldmUtc2UgcGFzc2FyIG8gcGFyw6JtZXRybyBgWC1QTy1TY3JlZW4tTG9ja2Agbm8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28gY29tIHZhbG9yIGAndHJ1ZSdgLlxuICpcbiAqIHBvciBleGVtcGxvOlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUE8tU2NyZWVuLUxvY2snOiAndHJ1ZScgfTtcbiAqXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogLi4uXG4gKlxuICogYGBgXG4gKiA+IEFww7NzIGEgdmFsaWRhw6fDo28gbm8gaW50ZXJjZXB0b3IsIG8gcGFyw6JtZXRybyBzZXLDoSByZW1vdmlkbyBkbyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8Ojby5cbiAqXG4gKiBBbyBpbXBvcnRhciBvIG3Ds2R1bG8gYFBvTW9kdWxlYCBuYSBhcGxpY2HDp8OjbywgbyBgcG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yYCDDqSBhdXRvbWF0aWNhbWVudGUgY29uZmlndXJhZG8gc2VtIGEgbmVjZXNzaWRhZGVcbiAqIGRlIHF1YWxxdWVyIGNvbmZpZ3VyYcOnw6NvIGV4dHJhLlxuICpcbiAqXG4gKiBTZWd1ZSBhYmFpeG8gdW0gZXhlbXBsbyBkZSB1c286XG4gKlxuICogYGBgXG4gKiBpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuICpcbiAqIC4uLlxuICpcbiAqIEBJbmplY3RhYmxlKClcbiAqIGV4cG9ydCBjbGFzcyBDdXN0b21lcnNTZXJ2aWNlIHtcbiAqXG4gKiAgaGVhZGVycyA9IHsgJ1gtUE8tTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc6IHRydWUsICdYLVBPLVNjcmVlbi1Mb2NrJzogJ3RydWUnIH1cbiAqICBwZW5kaW5nUmVxdWVzdHM6IG51bWJlciA9IDA7XG4gKiAgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gKlxuICogIGNvbnN0cnVjdG9yKFxuICogICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICogICAgcHJpdmF0ZSBodHRwUmVxdWVzdEludGVyY2VwdG9yOiBQb0h0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlKSB7IH1cbiAqXG4gKiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gKiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICogIH1cbiAqXG4gKiAgbmdPbkluaXQoKTogdm9pZCB7XG4gKiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMuaHR0cFJlcXVlc3RJbnRlcmNlcHRvci5nZXRDb3VudFBlbmRpbmdSZXF1ZXN0cygpLnN1YnNjcmliZShkYXRhID0+IHtcbiAqICAgICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMgPSBkYXRhO1xuICogICAgfSk7XG4gKiAgfVxuICpcbiAqICBnZXRDdXN0b21lcnMoKSB7XG4gKiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogIH1cbiAqXG4gKiAgLi4uXG4gKlxuICogfVxuICogYGBgXG4gKlxuICogQGV4YW1wbGVcbiAqIDxleGFtcGxlIG5hbWU9J3BvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci1sYWJzJyB0aXRsZT0nUE8gSHR0cCBSZXF1ZXN0IEludGVyY2VwdG9yIExhYnMnPlxuICogIDxmaWxlIG5hbWU9J3NhbXBsZS1wby1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3ItbGFicy5jb21wb25lbnQudHMnPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT0nc2FtcGxlLXBvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci1sYWJzLmNvbXBvbmVudC5odG1sJz4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBQb0h0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcbiAgcHJpdmF0ZSBsb2FkaW5nT3ZlcmxheUNvbXBvbmVudDogQ29tcG9uZW50UmVmPFBvTG9hZGluZ092ZXJsYXlDb21wb25lbnQ+ID0gdW5kZWZpbmVkO1xuXG4gIHByaXZhdGUgcGVuZGluZ1JlcXVlc3RzOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIG92ZXJsYXlSZXF1ZXN0czogbnVtYmVyID0gMDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNvbnRyb2xIdHRwUmVxdWVzdDogUG9IdHRwUmVxdWVzQ29udHJvbHRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcG9Db21wb25lbnRJbmplY3RvcjogUG9Db21wb25lbnRJbmplY3RvclNlcnZpY2VcbiAgKSB7fVxuXG4gIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcikge1xuICAgIGNvbnN0IHJlcXVlc3RDbG9uZSA9IHJlcXVlc3QuY2xvbmUoKTtcblxuICAgIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3RDbG9uZVdpdGhvdXRIZWFkZXJQYXJhbShbbm9Db3VudFBlbmRpbmdSZXF1ZXN0cywgc2NyZWVuTG9ja10sIHJlcXVlc3QpO1xuXG4gICAgdGhpcy5zZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyh0cnVlLCByZXF1ZXN0Q2xvbmUpO1xuICAgIHRoaXMuc2V0Q291bnRPdmVybGF5UmVxdWVzdHModHJ1ZSwgcmVxdWVzdENsb25lKTtcblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxuICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICB0aGlzLnNldENvdW50UGVuZGluZ1JlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgICB0aGlzLnNldENvdW50T3ZlcmxheVJlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgZ2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5jb250cm9sSHR0cFJlcXVlc3QuZ2V0Q29udHJvbEh0dHBSZXF1ZXN0KCk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkTG9hZGluZygpIHtcbiAgICBpZiAoIXRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQpIHtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQgPSB0aGlzLnBvQ29tcG9uZW50SW5qZWN0b3IuY3JlYXRlQ29tcG9uZW50SW5BcHBsaWNhdGlvbihQb0xvYWRpbmdPdmVybGF5Q29tcG9uZW50KTtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQuaW5zdGFuY2Uuc2NyZWVuTG9jayA9IHRydWU7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50Lmluc3RhbmNlLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRlc3Ryb3lMb2FkaW5nKCkge1xuICAgIGlmICh0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50KSB7XG4gICAgICB0aGlzLnBvQ29tcG9uZW50SW5qZWN0b3IuZGVzdHJveUNvbXBvbmVudEluQXBwbGljYXRpb24odGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCk7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVxdWVzdENsb25lV2l0aG91dEhlYWRlclBhcmFtKGhlYWRlcnNQYXJhbXM6IEFycmF5PHN0cmluZz4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBIdHRwUmVxdWVzdDxhbnk+IHtcbiAgICBsZXQgaXNSZXF1ZXN0Q2xvbmUgPSBmYWxzZTtcblxuICAgIGhlYWRlcnNQYXJhbXMuZm9yRWFjaChoZWFkZXJQYXJhbSA9PiB7XG4gICAgICBpZiAocmVxdWVzdC5oZWFkZXJzLmhhcyhoZWFkZXJQYXJhbSkpIHtcbiAgICAgICAgcmVxdWVzdCA9IHJlcXVlc3QuY2xvbmUoeyBoZWFkZXJzOiByZXF1ZXN0LmhlYWRlcnMuZGVsZXRlKGhlYWRlclBhcmFtKSB9KTtcbiAgICAgICAgaXNSZXF1ZXN0Q2xvbmUgPSB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGlzUmVxdWVzdENsb25lID8gcmVxdWVzdC5jbG9uZSh7IGhlYWRlcnM6IHJlcXVlc3QuaGVhZGVycyB9KSA6IHJlcXVlc3Q7XG4gIH1cblxuICBwcml2YXRlIHNldENvdW50UGVuZGluZ1JlcXVlc3RzKGlzSW5jcmVtZW50OiBib29sZWFuLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgaGFzQ291bnRQZW5kaW5nUmVxdWVzdEhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmhhcyhub0NvdW50UGVuZGluZ1JlcXVlc3RzKTtcbiAgICBjb25zdCBoZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5nZXQobm9Db3VudFBlbmRpbmdSZXF1ZXN0cyk7XG5cbiAgICBpZiAoaGFzQ291bnRQZW5kaW5nUmVxdWVzdEhlYWRlclBhcmFtICYmIGhlYWRlclBhcmFtLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMgKz0gaXNJbmNyZW1lbnQgPyAxIDogLTE7XG4gICAgdGhpcy5jb250cm9sSHR0cFJlcXVlc3Quc2VuZCh0aGlzLnBlbmRpbmdSZXF1ZXN0cyk7XG4gIH1cblxuICBwcml2YXRlIHNldENvdW50T3ZlcmxheVJlcXVlc3RzKGlzSW5jcmVtZW50OiBib29sZWFuLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgaGFzT3ZlcmxheVJlcXVlc3RIZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5oYXMoc2NyZWVuTG9jayk7XG5cbiAgICBpZiAoaGFzT3ZlcmxheVJlcXVlc3RIZWFkZXJQYXJhbSkge1xuICAgICAgY29uc3QgaGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KHNjcmVlbkxvY2spO1xuXG4gICAgICBpZiAoaGVhZGVyUGFyYW0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpID09PSAnZmFsc2UnKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5vdmVybGF5UmVxdWVzdHMgKz0gaXNJbmNyZW1lbnQgPyAxIDogLTE7XG4gICAgICB0aGlzLm92ZXJsYXlSZXF1ZXN0cyA+IDAgPyB0aGlzLmJ1aWxkTG9hZGluZygpIDogdGhpcy5kZXN0cm95TG9hZGluZygpO1xuICAgIH1cbiAgfVxufVxuIl19